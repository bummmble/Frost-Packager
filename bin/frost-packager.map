{"version":3,"file":"frost-packager","sources":["../src/helpers/banner.js","../src/helpers/targets.js","../src/helpers/outputMatrix.js","../src/helpers/utils.js","../src/cli.js"],"sourcesContent":["export default function getBanner(pkg) {\n    let banner = `/*! ${pkg.name} v${pkg.version}`;\n\n    if (pkg.author) {\n        if (typeof pkg.author === 'object') {\n            banner += `by ${pkg.author.name} <${pkg.author.email}>`;\n        }  else if (typeof pkg.author === 'string') {\n            banner += `by ${pkg.author}`;\n        }\n    }\n\n    banner += ' */';\n    return banner;\n}\n","export default function generateTargets(node, web, binary) {\n    const targets = {};\n    targets.node = generateNode(node);\n    targets.web = generateWeb(web);\n    targets.binary = generateBinary(binary);\n    return targets;\n}\n\nfunction generateNode(node) {\n    if (node) {\n        return [node];\n    }\n\n    return [\n        'src/server/index.js',\n        'src/server/main.js',\n        'src/server/server.js',\n        'server/index.js',\n        'server/server.js',\n        'server/main.js',\n        'src/server.js',\n        'src/index.js'\n    ];\n}\n\nfunction generateWeb(web) {\n    if (web) {\n        return [web];\n    }\n\n    return [\n        'src/web/index.js',\n        'src/web/web.js',\n        'src/web.js',\n        'src/browser/index.js',\n        'src/browser/main.js',\n        'src/browser/web.js',\n        'src/browser/client.js',\n        'src/client/index.js',\n        'src/client/main.js',\n        'src/client/client.js',\n        'client/index.js',\n        'client/web.js',\n        'client/main.js'\n    ];\n}\n\nfunction generateBinary(binary) {\n    if (binary) {\n        return [binary];\n    }\n    return ['src/binary.js', 'src/script.js', 'src/cli.js'];\n}\n","export function generateOutputMatrix(pkg, binaryOutput) {\n    return {\n        'node-classic-commonjs': pkg['main'] || null,\n        'node-classic-esmodule': pkg['module'] || pkg['jsnext:main'] || null,\n\n        'node-es2015-commonjs': pkg['main:es2015'] || null,\n        'node-es2015-esmodule': pkg['es2015'] || pkg['module:es2015'] || null,\n\n        'node-modern-commonjs': pkg['main:modern'] || null,\n        'node-modern-esmodule': pkg['module:modern'] || null,\n\n        'binary-binary-commonjs': binaryOutput || null\n    };\n}\n\nexport function ammendOutputMatrix(matrix, output) {\n    matrix['node-classic-commonjs'] = `${output}/node.classic.commonjs.js`;\n    matrix['node-classic-esmodule'] = `${output}/node.classic.esmodule.js`;\n    matrix['node-es2015-commonjs'] = `${output}/node.es2015.commonjs.js`;\n    matrix['node-es2015-esmodule'] = `${output}/node.es2015.esmodule.js`;\n\n    matrix['node-modern-commonjs'] = `${output}/node.modern.commonjs.js`;\n    matrix['node-modern-esmodule'] = `${output}/node.modern.esmodule.js`;\n    return matrix;\n}\n","import { sync } from 'file-exists';\n\nexport function findBest(candidates) {\n    const filtered = candidates.filter(sync);\n    return filtered[0];\n}\n\nexport function camelize(str) {\n    return str.replace(/-(.)/g, (_, char) => {\n        return char.toUpperCase();\n    });\n}\n","import meow from 'meow';\nimport chalk from 'chalk';\nimport nodeResolve from 'rollup-plugin-rebase';\nimport commonjs from 'rollup-plugin-commonjs';\nimport jsonPlugin from 'rollup-plugin-json';\nimport yamlPlugin from 'rollup-plugin-yaml';\nimport replacePlugin from 'rollup-plugin-replace';\nimport exec from 'rollup-plugin-exec';\n\nimport { resolve, relative, isAbsolute } from 'path';\nimport { eachOfSeries } from 'async';\nimport { rollup } from 'rollup';\nimport { get as getRoot } from 'app-root-dir';\n\nimport getBanner from './helpers/banner';\nimport generateTargets from './helpers/targets';\nimport { generateOutputMatrix, ammendOutputMatrix } from './helpers/outputMatrix';\nimport { findBest, camelize } from './helpers/utils';\nimport { getTranspilers } from './helpers/transpilers';\n\nlet cache;\n\nexport const Root = getRoot();\nexport const pkg = require(resolve(Root, 'package.json'));\n\nconst command = meow(`\n    Usage\n        $ frost-packager\n\n    Options\n        --input-node\n        --input-web\n        --input-binary\n\n        --output-folder\n\n        -t, --transpiler\n        -x, --minified,\n        -m, --sourcemap\n        --target-unstable\n\n        -v, --verbose\n        -q, --quiet\n`, {\n    flags: {\n        inputNode: {\n            default: null\n        },\n        inputWeb: {\n            default: null\n        },\n        inputBinary: {\n            default: null\n        },\n        outputFolder: {\n            default: null\n        },\n\n        transpiler: {\n            default: 'babel',\n            alias: 't'\n        },\n\n        minified: {\n            default: false,\n            alias: 'x'\n        },\n\n        sourcemap: {\n            default: true,\n            alias: 'm'\n        },\n\n        targetUnstable: {\n            default: false\n        },\n\n        verbose: {\n            default: false,\n            alias: 'v'\n        },\n\n        quiet: {\n            default: false,\n            alias: 'q'\n        }\n    }\n});\n\nconst { verbose, quiet, targetUnstable, outputFolder, inputWeb, inputNode, inputBinary, minified, transpiler } = command.flags;\nif (verbose) {\n    console.log(`Flags: ${command.flags}`);\n}\n\nconst binaryConfig = pkg.bin;\nlet binaryOutput = null;\nif (binaryConfig) {\n    for (const name in binaryConfig) {\n        binaryOutput = binaryConfig[name];\n        break;\n    }\n}\n\nlet outputMatrix = generateOutputMatrix(pkg, binaryOutput);\nif (outputFolder) {\n    outputMatrix = ammendOutputMatrix(outputMatrix, pkg);\n}\n\nconst rollupFormat = {\n    commonjs: 'cjs',\n    esmodule: 'es'\n};\n\nconst formats = ['esmodule', 'commonjs'];\nconst name = pkg.name || camelize(pkg.name);\nconst banner = getBanner(pkg);\nconst targets = generateTargets(inputNode, inputWeb, inputBinary);\n\nexport function generateBuilds() {\n    try {\n        eachOfSeries(targets, (env, targetId, targetCb) => {\n            const input = findBest(env);\n            if (input) {\n                eachOfSeries(formats, (format, formatId, formatCb) => {\n                    const transpilers = getTraspilers(transpiler, {\n                        minified,\n                        presets: [],\n                        plugins: [],\n                        targetUnstable\n                    });\n                    eachOfSeries(transpilers, (transpilers, transpilerId, transpilerCb) => {\n                        const outputFile = outputMatrix[`${targetId}-${transpilerCb}-${format}`];\n                        if (outputFile) {\n                            return createBundle({\n                                input,\n                                targetId,\n                                transpilerId,\n                                current,\n                                format,\n                                outputFile,\n                                transpilerCb\n                            });\n                        } else {\n                            return transpilerCb(null);\n                        }\n                    }, formatCb)\n                }, targetCb)\n            } else {\n                targetCb(null);\n            }\n        })\n    } catch (err) {\n        console.error(err);\n        process.exit(1);\n    }\n}\n\nexport function createBundle({\n    input,\n    targetId,\n    transpilerId,\n    current,\n    format,\n    outputFile,\n    transpilerCb\n}) {\n    const prefix = 'process.env.';\n    const vars = {\n        [`${prefix}NAME`]: JSON.stringify(pkg.name),\n        [`${prefix}VERSION`]: JSON.stringify(pkg.version),\n        [`${prefix}TARGET`]: JSON.stringify(targetId)\n    };\n\n    return rollup({\n        input,\n        cache,\n        onwarn: warn => console.warn(chalk.red(`- ${warn.message}`)),\n        external(dependency) {\n            if (dependency == input) {\n                return false;\n            }\n\n            if (isAbsolute(dependency)) {\n                const relativePath = relative(Root, dependency);\n                return Boolean(/node_modules/.exec(relativePath));\n            }\n\n            return dependency.charAt(0) !== '.';\n        },\n        plugins: [\n            nodeResolve({\n                extensions: ['.mjs', '.js', '.jsx', '.ts', '.tsx', '.json'],\n                jsnext: true,\n                module: true,\n                main: true\n            }),\n            replacePlugin(vars),\n            commonjs({\n                include: 'node_modules/**'\n            }),\n            yamlPlugin(),\n            jsonPlugin(),\n            current,\n            transpilerId === 'binary' ? exec() : null\n        ]\n    })\n    .then(({ write }) => write({\n        banner: transpilerId === 'binary'\n            ? `#!/usr/bin/env node\\n\\n${banner}`\n            : banner,\n        file: outputFile,\n        format: rollupFormat[format],\n        name,\n        sourcemap: command.flags.sourcemap,\n    }))\n    .then(() => transpilerCb(null))\n    .catch(err => {\n        console.error(err);\n        transpilerCb(`Error during bundling ${input} in ${format}: Error: ${err}`);\n    });\n}\n"],"names":["let","const","sync","getRoot","resolve","name","eachOfSeries","rollup","isAbsolute","relative"],"mappings":"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"}